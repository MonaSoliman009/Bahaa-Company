import * as tslib_1 from "tslib";
import { ScrollStrategy, ScrollStrategyOptions } from '@angular/cdk/overlay';
import { Component, EventEmitter, forwardRef, Input, Output, ViewChild, ViewEncapsulation, HostListener, } from '@angular/core';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
import { AngularTagsInputService } from './angular-tags-input.service';
import { TagInputComponent } from './tag-input/tag-input.component';
import { UnAddedTagsPipe } from './un-added-tags.pipe';
import { DropdownComponent } from './dropdown/dropdown.component';
import { KEY_CODES } from './constants';
let AngularTagsInputComponent = class AngularTagsInputComponent {
    constructor(sso, tagsService) {
        this.sso = sso;
        this.tagsService = tagsService;
        this.tagsData = [];
        this.disabled = false;
        this.dropDownTemplate = null;
        this.tagItemTemplate = null;
        this.required = false;
        this.tagRemoved = new EventEmitter();
        this.tagAdded = new EventEmitter();
        this.valueChanged = new EventEmitter();
        this.itemClicked = new EventEmitter();
        this.tags = [];
        this.defaultConfig = {
            defaultClass: 'angular-tags-input',
            additionalClasses: '',
            displayProperty: 'value',
            identifier: 'id',
            onlyFromAutoComplete: false,
            placeholder: 'Search',
            hideAddedTags: true,
            nestedTagProperty: '',
            showTagsSelectedInDD: false,
            hideTags: false,
            maxItems: null,
            nestedTagParentProp: '',
            keyboardActiveClass: 'angular-tags-dropdown__list__item--active'
        };
        this.dropdownOverlayPosition = [
            { offsetY: 12, originX: 'start', originY: 'bottom', overlayX: 'start', overlayY: 'top' },
            { offsetY: -28, originX: 'start', originY: 'top', overlayX: 'start', overlayY: 'bottom' },
            { offsetY: 28, originX: 'end', originY: 'bottom', overlayX: 'end', overlayY: 'bottom' },
            { offsetY: -28, originX: 'end', originY: 'top', overlayX: 'end', overlayY: 'bottom' },
        ];
        this.unAddedTagsPipe = new UnAddedTagsPipe();
    }
    keyEvent(event) {
        this.inputKeyPress(event);
    }
    ngOnChanges(changes) {
        // if there's no change in the tagsData, do nothing
        if (!changes.tagsData || !this.isInputFocused) {
            return;
        }
        // If the previous walue was `null` or `undefined`, we're initializing that as an array here
        // so we can avoid breaking the process further.
        if (!changes.tagsData.previousValue) {
            changes.tagsData.previousValue = [];
        }
        // if we have the value of the tags changed, we need to show the dropdown immediately
        // we don't show this on the first change, because that's when the first value is assigned
        if (changes.tagsData && changes.tagsData.currentValue !== changes.tagsData.previousValue
            && !changes.tagsData.firstChange) {
            // if the values don't match, show the dropdown
            if (changes.tagsData.currentValue.length !== changes.tagsData.previousValue.length && !!this.dropdownShownYet) {
                return this.showDropdown(changes.tagsData.currentValue);
            }
            if (changes.tagsData.previousValue.length === 0) {
                return;
            }
            /* since the values are array, we need to compare the elements within
             * avoiding the usage of any external library, matching the elements using identifier
             * of the elements here
             */
            for (let i = 0, len = changes.tagsData.currentValue.length; i < len; ++i) {
                if (changes.tagsData.currentValue[i][this.config.identifier] !== changes.tagsData.previousValue[i][this.config.identifier]) {
                    // as soon as the difference in elements is found, show the element and stop further execution of for loop
                    return this.showDropdown(changes.tagsData.currentValue);
                }
            }
        }
    }
    onFocusChange(val) {
        this.isInputFocused = val;
        if (!val && this.config.hideDDOnBlur) {
            setTimeout(() => {
                this.hideDropdown();
            }, 400);
        }
    }
    onInputValueChanged(val) {
        this.inputVal = val;
        this.valueChanged.emit(val);
    }
    ngOnInit() {
        this.config = Object.assign({}, this.defaultConfig, this.config);
        this.ddScrollStrategy = this.sso.reposition();
    }
    /**
     * @author Ahsan Ayaz
     * @desc Triggers when the value of the form control (or ngModel) is changed.
     * We're using the handler to assign the values to the tags array that we have.
     */
    writeValue(tags) {
        tags = tags ? tags : [];
        tags = Array.isArray(tags) ? tags : [tags];
        this.tags = tags.map((tag) => {
            return Object.assign({}, tag, {
                [this.config.identifier]: tag[this.config.identifier],
                [this.config.displayProperty]: tag[this.config.displayProperty],
            });
        });
        if (this.config.showTagsSelectedInDD) {
            setTimeout(() => {
                this.tags.map((tag) => {
                    this.selectRelatedTags(tag);
                });
            });
        }
    }
    /**
     * @author Ahsan Ayaz
     * @desc Registers the on change function to the value accessor
     */
    registerOnChange(fn) {
        this.onChange = fn;
    }
    /**
     * Validator function for the form control
     * Doesn't do anything if the control is not required
     * If it is required, checks if the control contains value
     */
    validate(control) {
        if (this.required === false) {
            return null;
        }
        return (!!control.value && control.value.length) ? null : {
            required: true,
        };
    }
    /**
     * @author Ahsan Ayaz
     * @desc Triggers when the tag input is focused
     */
    onInputFocus() {
        if (this.config.clearInputOnFocus) {
            if (this.tagInput.lastValueEmitted !== '') {
                this.tagInput.tagInputForm.get('tagInputVal').setValue('');
            }
            this.tagInput.resetInput();
        }
        if (this.config.clearTagsOnFocus) {
            this.tags.length = 0;
        }
        this.showDropdown();
        this.onFocusChange(true);
    }
    /**
     * @author Ahsan Ayaz
     * @desc Shows the dropdown with options listing
     */
    showDropdown(recentTags = null) {
        const unAddedTags = this.unAddedTagsPipe.transform(!!recentTags ? recentTags : this.tagsData, {
            tagsAdded: this.tags,
            config: this.config
        });
        if (unAddedTags.length) { // only show dropdown when we have data to show
            this.isDropdownOpen = true;
        }
        if (!this.dropdownShownYet) {
            this.dropdownShownYet = true;
        }
    }
    /**
     * @author Ahsan Ayaz
     * @desc Hides the options listing dropdown
     */
    hideDropdown() {
        this.isDropdownOpen = false;
        this.tagsData = this.removeKeyboardSelection(this.tagsData);
    }
    removeKeyboardSelection(items) {
        return items.map((tag) => {
            if (tag[this.config.nestedTagProperty] && tag[this.config.nestedTagProperty].length) {
                tag[this.config.nestedTagProperty] = this.removeKeyboardSelection(tag[this.config.nestedTagProperty]);
            }
            return Object.assign({}, tag, { tiKeyboardActive: false });
        });
    }
    ngAfterViewInit() {
        if (!!this.config || !this.onChange) {
            console.warn('Please use ngModel or FormControlName with <ti-angular-tags-input>');
        }
        if (this.config.nestedTagProperty) {
            // we need the parent property to be able to unselect the parent when a child tag is unselected
            if (!this.config.nestedTagParentProp) {
                // tslint:disable-next-line:max-line-length
                throw new Error('nestedTagProperty provided but nestedTagParentProp not provided.\nThis will cause the parent tag to not remove if any of the children is removed');
            }
        }
    }
    /**
     * @author Ahsan Ayaz
     * @desc Adds the tag in the tags list (tags array).
     * Avoids duplicate tags addition
     * @param tag - tag to add
     */
    addTag(tag) {
        if (this.config.showTagsSelectedInDD) {
            tag.tiSelected = true; // marks the element as selected
        }
        if (this.config.maxItems > 0 && this.tags.length === this.config.maxItems) {
            return;
        }
        if (!this.tags.find(tagItem => tagItem[this.config.identifier] === tag[this.config.identifier])) {
            this.tags = [...this.tags, tag];
            this.onChange(this.tags);
        }
    }
    /**
     * @author Ahsan Ayaz
     * @desc Removes the tags from the tags list
     * @param tag - tag to remove
     */
    removeTag(tag) {
        this.tags = this.tags.filter((tagItem) => tagItem[this.config.identifier] !== tag[this.config.identifier]);
        // when we've removed all the tags, we want to get the default tags
        if (this.tags.length === 0) {
            this.tagInput.resetInput();
            this.valueChanged.emit('');
        }
        this.onChange(this.tags);
    }
    /**
     * @author Ahsan Ayaz
     * @desc Triggers when the item is clicked from the dropdown
     * @param tag - tag selected
     */
    onItemClicked(tag) {
        // if we don't have to toggle, add the item as tag right away
        if (this.config.toggleSelectionOnClick) {
            // we have to toggle selection. First, let's see if the tag doesn't exist already in the selected tags
            if (!tag.tiSelected && !this.tags.find(tagItem => tagItem[this.config.identifier] === tag[this.config.identifier])) {
                this.addTag(tag);
                this.selectRelatedTags(tag);
                this.tagAdded.emit(this.tagsService.getMainTagAfterAdding(this.tagsData, tag, this.tags, this.config));
            }
            else { // if the tag is already selected, remove
                this.removeTag(tag);
                this.removeTagSelection(tag);
                this.tagRemoved.emit(tag);
            }
        }
        else {
            this.addTag(tag);
            this.selectRelatedTags(tag);
            this.tagAdded.emit(this.tagsService.getMainTagAfterAdding(this.tagsData, tag, this.tags, this.config));
        }
        this.tagInput.resetInput();
        this.itemClicked.emit(tag);
        this.hideDropdown();
    }
    /**
     * @author Ahsan Ayaz
     * @desc Removes the tag seleced state (and of the children)
     * @param tag - the tag to unmark as selected
     */
    removeTagSelection(tag, ignoreChildren = false, ignoreParent = false) {
        tag.tiSelected = false;
        if (!ignoreChildren && tag[this.config.nestedTagProperty]) {
            for (let i = 0, len = tag[this.config.nestedTagProperty].length; i < len; ++i) {
                this.removeTag(tag[this.config.nestedTagProperty][i]);
                this.removeTagSelection(tag[this.config.nestedTagProperty][i], ignoreChildren);
            }
        }
        if (tag[this.config.nestedTagParentProp] && !ignoreParent) {
            const parentTag = this.tagsService.findTagById(this.tagsData, tag[this.config.nestedTagParentProp], this.config);
            if (parentTag && parentTag.tiSelected) {
                this.removeTag(parentTag);
                this.removeTagSelection(parentTag, true, ignoreParent);
                parentTag[this.config.nestedTagProperty].map((tagItem) => {
                    // tslint:disable-next-line:triple-equals
                    if (tagItem[this.config.identifier] != tag[this.config.identifier]) {
                        this.addTag(tagItem);
                        this.selectRelatedTags(tagItem, false, true);
                    }
                });
            }
        }
        this.onChange(this.tags);
    }
    /**
     * @author Ahsan Ayaz
     * @desc triggers on close button click of the tags
     * @param tag - the tag to remove
     */
    tagCloseClicked(tag) {
        this.tagRemoved.emit(tag);
        this.removeTag(tag);
        this.removeTagSelection(tag);
    }
    /**
     * @author Ahsan Ayaz
     * @desc Selects/adds the retated tags (parent and/or children)
     * @param tag - the tag to mark as selected
     */
    selectRelatedTags(tag, ignoreChildren = false, ignoreParent = false) {
        if (this.config.showTagsSelectedInDD) {
            tag.tiSelected = true;
        }
        if (tag[this.config.nestedTagProperty] && !ignoreChildren) {
            for (let i = 0, len = tag[this.config.nestedTagProperty].length; i < len; ++i) {
                if (this.config.showParentTagsOnly) {
                    // remove the children if we only have to keep parent
                    this.removeTag(tag[this.config.nestedTagProperty][i]);
                    // making sure we're targeting only children, ignoring parents
                    this.selectRelatedTags(tag[this.config.nestedTagProperty][i], false, true);
                }
                else {
                    this.addTag(tag[this.config.nestedTagProperty][i]);
                }
            }
        }
        if (tag[this.config.nestedTagParentProp] && !ignoreParent) {
            const parentTag = this.tagsService.findTagById(this.tagsData, tag[this.config.nestedTagParentProp], this.config);
            if (!parentTag) {
                return;
            }
            const parentTagChildren = parentTag[this.config.nestedTagProperty].length;
            const childrensSelected = this.tags.filter((tagItem) => {
                // tslint:disable-next-line:triple-equals
                return tagItem[this.config.nestedTagParentProp] == parentTag[this.config.identifier];
            }).length;
            if ((parentTagChildren > 0 && childrensSelected > 0) &&
                (this.config.childrenCountProperty ?
                    childrensSelected === parentTag[this.config.childrenCountProperty] :
                    childrensSelected === parentTagChildren)) {
                this.addTag(parentTag);
                this.selectRelatedTags(parentTag, false, false);
            }
        }
        this.onChange(this.tags);
    }
    registerOnTouched(fn) {
        // throw new Error("Method not implemented.");
    }
    inputKeyPress($event) {
        $event.stopImmediatePropagation();
        if (!this.isDropdownOpen &&
            ($event.key === KEY_CODES.ARROW_UP ||
                $event.key === KEY_CODES.ARROW_DOWN)) {
            this.isDropdownOpen = true;
        }
        else if (this.isDropdownOpen &&
            $event.key === KEY_CODES.ESCAPE) {
            return this.hideDropdown();
        }
        // so we have the dropdown shown
        setTimeout(() => {
            if (this.dropdown) {
                this.dropdown.handleKeyUp($event);
            }
        }, 10);
    }
};
AngularTagsInputComponent.ctorParameters = () => [
    { type: ScrollStrategyOptions },
    { type: AngularTagsInputService }
];
tslib_1.__decorate([
    ViewChild(DropdownComponent, { static: false })
], AngularTagsInputComponent.prototype, "dropdown", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "config", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "tagsData", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "disabled", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "tagsLoading", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "dropDownTemplate", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "tagItemTemplate", void 0);
tslib_1.__decorate([
    Input()
], AngularTagsInputComponent.prototype, "required", void 0);
tslib_1.__decorate([
    Output()
], AngularTagsInputComponent.prototype, "tagRemoved", void 0);
tslib_1.__decorate([
    Output()
], AngularTagsInputComponent.prototype, "tagAdded", void 0);
tslib_1.__decorate([
    Output()
], AngularTagsInputComponent.prototype, "valueChanged", void 0);
tslib_1.__decorate([
    Output()
], AngularTagsInputComponent.prototype, "itemClicked", void 0);
tslib_1.__decorate([
    ViewChild(TagInputComponent, { static: true })
], AngularTagsInputComponent.prototype, "tagInput", void 0);
tslib_1.__decorate([
    HostListener('keyup', ['$event'])
], AngularTagsInputComponent.prototype, "keyEvent", null);
AngularTagsInputComponent = tslib_1.__decorate([
    Component({
        selector: 'ti-angular-tags-input',
        template: "<div\n  class=\"angular-tags-input\"\n  [ngClass]=\"config.defaultClass + ' ' + config.additionalClasses\">\n  <div class=\"angular-tags-input__inp-container\" #dropdownTrigger=\"cdkOverlayOrigin\" cdkOverlayOrigin>\n    <ng-container *ngIf=\"!config.hideTags\">\n      <ti-tag\n        class=\"angular-tags-input__inp-container__tag\"\n        *ngFor=\"let tagItem of tags\"\n        [config]=\"config\"\n        [tagItem]=\"tagItem\"\n        [tagItemTemplate]=\"tagItemTemplate\"\n        (closeClicked)=\"tagCloseClicked($event)\">\n      </ti-tag>\n    </ng-container>\n    <ti-tag-input\n      [style.display]=\"config.hideInputOnSelection && tags.length ? 'none' : 'block'\"\n      [config]=\"config\"\n      [disabled]=\"disabled\"\n      class=\"angular-tags-input__inp-container__tag-input\"\n      (tagEntered)=\"addTag($event)\"\n      (valueChanged)=\"onInputValueChanged($event)\"\n      (inputFocused)=\"onInputFocus()\"\n      (inputBlurred)=\"onFocusChange(false);\"\n      (inputKeyPress)=\"inputKeyPress($event)\">\n    </ti-tag-input>\n  </div>\n  \n  <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]=\"dropdownTrigger\" [cdkConnectedOverlayOpen]=\"isDropdownOpen\"\n    [cdkConnectedOverlayHasBackdrop]=\"config.ddHasBackdrop\" (backdropClick)=\"hideDropdown()\"\n    [cdkConnectedOverlayPanelClass]=\"'angular-tags-input-dd-overlay' + config.dropdownClass ? config.dropdownClass : ''\"\n    [cdkConnectedOverlayScrollStrategy]=\"ddScrollStrategy\"\n    [cdkConnectedOverlayPositions]=\"dropdownOverlayPosition\"\n    [cdkConnectedOverlayMinWidth]=\"310\">\n    <div class=\"angular-tags-input__dd-container\">\n      <ti-dropdown\n        [inputVal]=\"inputVal\"\n        (itemClicked)=\"onItemClicked($event);\"\n        [dropDownTemplate]=\"dropDownTemplate\"\n        [listItems]=\"tagsData | unAddedTags: {tagsAdded: tags, config: config}\"\n        [config]=\"config\"\n        (itemAdded)=\"addTag($event);\">\n      </ti-dropdown>\n    </div>\n  </ng-template>\n</div>\n",
        providers: [
            getAngularTagsInputValueAccessor(),
            getAngularTagsInputValidatorsProvider()
        ],
        encapsulation: ViewEncapsulation.None,
        styles: ["ti-angular-tags-input{display:block;width:100%}.angular-tags-input{display:flex;flex-direction:row;align-items:center;margin:-3px 0}.angular-tags-input__inp-container{width:100%;display:flex;flex-direction:row;align-items:center;background:#fff;flex-wrap:wrap;padding:9px 18px 18px;position:relative;top:4px}.angular-tags-input__inp-container__tag-input{flex:1}.angular-tags-input__inp-container__tag{margin:0 10px 8px 0}.angular-tags-input__dd-container{display:block;width:100%}.cdk-overlay-container.select-assignee-overlay{z-index:1050}.cdk-overlay-container.task-menu-popover-overlay{z-index:2050}.duplicate-modal-overlay{z-index:999}.cdk-overlay-backdrop{display:block}.cdk-global-overlay-wrapper,.cdk-overlay-container{pointer-events:none;top:0;left:0;height:100%;width:100%}.cdk-overlay-container{display:block;position:fixed;z-index:1000}.cdk-overlay-container:empty{display:none}.cdk-global-overlay-wrapper{display:flex;position:absolute;z-index:1000}.cdk-overlay-pane{position:absolute;pointer-events:auto;box-sizing:border-box;background-color:#fff;z-index:1000;display:flex;max-width:100%;max-height:100%;border:1px solid #fff;box-shadow:0 2px 14px 4px rgba(0,0,0,.1)}.cdk-overlay-backdrop{position:absolute;top:0;bottom:0;left:0;right:0;z-index:1000;pointer-events:auto;-webkit-tap-highlight-color:transparent;transition:opacity .4s cubic-bezier(.25,.8,.25,1);opacity:0}"]
    })
], AngularTagsInputComponent);
export { AngularTagsInputComponent };
export function getAngularTagsInputValueAccessor() {
    return {
        provide: NG_VALUE_ACCESSOR,
        useExisting: forwardRef(() => AngularTagsInputComponent),
        multi: true,
    };
}
export function getAngularTagsInputValidatorsProvider() {
    return {
        provide: NG_VALIDATORS,
        useExisting: forwardRef(() => AngularTagsInputComponent),
        multi: true,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci10YWdzLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bpb21lY2hzL2FuZ3VsYXItdGFncy1pbnB1dC8iLCJzb3VyY2VzIjpbImxpYi9hbmd1bGFyLXRhZ3MtaW5wdXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDN0UsT0FBTyxFQUVMLFNBQVMsRUFDVCxZQUFZLEVBQ1osVUFBVSxFQUNWLEtBQUssRUFHTCxNQUFNLEVBR04sU0FBUyxFQUNULGlCQUFpQixFQUNqQixZQUFZLEdBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUF3QixpQkFBaUIsRUFBRSxhQUFhLEVBQTBCLE1BQU0sZ0JBQWdCLENBQUM7QUFFaEgsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDdkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFZeEMsSUFBYSx5QkFBeUIsR0FBdEMsTUFBYSx5QkFBeUI7SUEyQ3BDLFlBQ21CLEdBQTBCLEVBQ25DLFdBQW9DO1FBRDNCLFFBQUcsR0FBSCxHQUFHLENBQXVCO1FBQ25DLGdCQUFXLEdBQVgsV0FBVyxDQUF5QjtRQTFDckMsYUFBUSxHQUFlLEVBQUUsQ0FBQztRQUMxQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBRWpCLHFCQUFnQixHQUFxQixJQUFJLENBQUM7UUFDMUMsb0JBQWUsR0FBcUIsSUFBSSxDQUFDO1FBQ3pDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDaEIsZUFBVSxHQUFHLElBQUks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WUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO3lEQUdqQztBQXBEVSx5QkFBeUI7SUFWckMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHVCQUF1QjtRQUNqQyx1K0RBQWtEO1FBRWxELFNBQVMsRUFBRTtZQUNULGdDQUFnQyxFQUFFO1lBQ2xDLHFDQUFxQyxFQUFFO1NBQ3hDO1FBQ0QsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O0tBQ3RDLENBQUM7R0FDVyx5QkFBeUIsQ0EwYnJDO1NBMWJZLHlCQUF5QjtBQTZidEMsTUFBTSxVQUFVLGdDQUFnQztJQUM5QyxPQUFPO1FBQ0wsT0FBTyxFQUFFLGlCQUFpQjtRQUMxQixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHlCQUF5QixDQUFDO1FBQ3hELEtBQUssRUFBRSxJQUFJO0tBQ1osQ0FBQztBQUNKLENBQUM7QUFFRCxNQUFNLFVBQVUscUNBQXFDO0lBQ25ELE9BQU87UUFDTCxPQUFPLEVBQUUsYUFBYTtRQUN0QixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHlCQUF5QixDQUFDO1FBQ3hELEtBQUssRUFBRSxJQUFJO0tBQ1osQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTY3JvbGxTdHJhdGVneSwgU2Nyb2xsU3RyYXRlZ3lPcHRpb25zIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIGZvcndhcmRSZWYsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NoaWxkLFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgSG9zdExpc3RlbmVyLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBOR19WQUxVRV9BQ0NFU1NPUiwgTkdfVkFMSURBVE9SUywgVmFsaWRhdG9yLCBGb3JtQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcblxuaW1wb3J0IHsgQW5ndWxhclRhZ3NJbnB1dFNlcnZpY2UgfSBmcm9tICcuL2FuZ3VsYXItdGFncy1pbnB1dC5zZXJ2aWNlJztcbmltcG9ydCB7IFRhZ0lucHV0Q29tcG9uZW50IH0gZnJvbSAnLi90YWctaW5wdXQvdGFnLWlucHV0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBbmd1bGFyVGFnSXRlbSwgQW5ndWxhclRhZ3NJbnB1dENvbmZpZyB9IGZyb20gJy4vdGFncy1pbnB1dC1pbnRlcmZhY2VzJztcbmltcG9ydCB7IFVuQWRkZWRUYWdzUGlwZSB9IGZyb20gJy4vdW4tYWRkZWQtdGFncy5waXBlJztcbmltcG9ydCB7IERyb3Bkb3duQ29tcG9uZW50IH0gZnJvbSAnLi9kcm9wZG93bi9kcm9wZG93bi5jb21wb25lbnQnO1xuaW1wb3J0IHsgS0VZX0NPREVTIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0aS1hbmd1bGFyLXRhZ3MtaW5wdXQnLFxuICB0ZW1wbGF0ZVVybDogJy4vYW5ndWxhci10YWdzLWlucHV0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vYW5ndWxhci10YWdzLWlucHV0LmNvbXBvbmVudC5zY3NzJ10sXG4gIHByb3ZpZGVyczogW1xuICAgIGdldEFuZ3VsYXJUYWdzSW5wdXRWYWx1ZUFjY2Vzc29yKCksXG4gICAgZ2V0QW5ndWxhclRhZ3NJbnB1dFZhbGlkYXRvcnNQcm92aWRlcigpXG4gIF0sXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgQW5ndWxhclRhZ3NJbnB1dENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE9uQ2hhbmdlcywgVmFsaWRhdG9yIHtcbiAgQFZpZXdDaGlsZChEcm9wZG93bkNvbXBvbmVudCwgeyBzdGF0aWM6IGZhbHNlIH0pIGRyb3Bkb3duOiBEcm9wZG93bkNvbXBvbmVudDtcbiAgQElucHV0KCkgY29uZmlnOiBBbmd1bGFyVGFnc0lucHV0Q29uZmlnO1xuICBASW5wdXQoKSB0YWdzRGF0YTogQXJyYXk8YW55PiA9IFtdO1xuICBASW5wdXQoKSBkaXNhYmxlZCA9IGZhbHNlO1xuICBASW5wdXQoKSB0YWdzTG9hZGluZzogYm9vbGVhbjtcbiAgQElucHV0KCkgZHJvcERvd25UZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiA9IG51bGw7XG4gIEBJbnB1dCgpIHRhZ0l0ZW1UZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiA9IG51bGw7XG4gIEBJbnB1dCgpIHJlcXVpcmVkID0gZmFsc2U7XG4gIEBPdXRwdXQoKSB0YWdSZW1vdmVkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAT3V0cHV0KCkgdGFnQWRkZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSB2YWx1ZUNoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBpdGVtQ2xpY2tlZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQFZpZXdDaGlsZChUYWdJbnB1dENvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSkgdGFnSW5wdXQ6IFRhZ0lucHV0Q29tcG9uZW50O1xuICB0YWdzOiBBcnJheTxBbmd1bGFyVGFnSXRlbT4gPSBbXTtcbiAgaXNJbnB1dEZvY3VzZWQ6IGJvb2xlYW47XG4gIGlucHV0VmFsOiBzdHJpbmc7XG4gIGRlZmF1bHRDb25maWc6IEFuZ3VsYXJUYWdzSW5wdXRDb25maWcgPSB7XG4gICAgZGVmYXVsdENsYXNzOiAnYW5ndWxhci10YWdzLWlucHV0JyxcbiAgICBhZGRpdGlvbmFsQ2xhc3NlczogJycsXG4gICAgZGlzcGxheVByb3BlcnR5OiAndmFsdWUnLFxuICAgIGlkZW50aWZpZXI6ICdpZCcsXG4gICAgb25seUZyb21BdXRvQ29tcGxldGU6IGZhbHNlLFxuICAgIHBsYWNlaG9sZGVyOiAnU2VhcmNoJyxcbiAgICBoaWRlQWRkZWRUYWdzOiB0cnVlLFxuICAgIG5lc3RlZFRhZ1Byb3BlcnR5OiAnJyxcbiAgICBzaG93VGFnc1NlbGVjdGVkSW5ERDogZmFsc2UsXG4gICAgaGlkZVRhZ3M6IGZhbHNlLFxuICAgIG1heEl0ZW1zOiBudWxsLFxuICAgIG5lc3RlZFRhZ1BhcmVudFByb3A6ICcnLFxuICAgIGtleWJvYXJkQWN0aXZlQ2xhc3M6ICdhbmd1bGFyLXRhZ3MtZHJvcGRvd25fX2xpc3RfX2l0ZW0tLWFjdGl2ZSdcbiAgfTtcbiAgb25DaGFuZ2U6IChpdGVtczogQW5ndWxhclRhZ0l0ZW1bXSkgPT4gdm9pZDtcbiAgZHJvcGRvd25PdmVybGF5UG9zaXRpb24gPSBbXG4gICAgeyBvZmZzZXRZOiAxMiwgb3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ2JvdHRvbScsIG92ZXJsYXlYOiAnc3RhcnQnLCBvdmVybGF5WTogJ3RvcCcgfSxcbiAgICB7IG9mZnNldFk6IC0yOCwgb3JpZ2luWDogJ3N0YXJ0Jywgb3JpZ2luWTogJ3RvcCcsIG92ZXJsYXlYOiAnc3RhcnQnLCBvdmVybGF5WTogJ2JvdHRvbScgfSxcbiAgICB7IG9mZnNldFk6IDI4LCBvcmlnaW5YOiAnZW5kJywgb3JpZ2luWTogJ2JvdHRvbScsIG92ZXJsYXlYOiAnZW5kJywgb3ZlcmxheVk6ICdib3R0b20nIH0sXG4gICAgeyBvZmZzZXRZOiAtMjgsIG9yaWdpblg6ICdlbmQnLCBvcmlnaW5ZOiAndG9wJywgb3ZlcmxheVg6ICdlbmQnLCBvdmVybGF5WTogJ2JvdHRvbScgfSxcbiAgXTtcbiAgZGRTY3JvbGxTdHJhdGVneTogU2Nyb2xsU3RyYXRlZ3k7XG4gIGlzRHJvcGRvd25PcGVuOiBib29sZWFuO1xuICBkcm9wZG93blNob3duWWV0OiBib29sZWFuO1xuICB1bkFkZGVkVGFnc1BpcGUgPSBuZXcgVW5BZGRlZFRhZ3NQaXBlKCk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc3NvOiBTY3JvbGxTdHJhdGVneU9wdGlvbnMsXG4gICAgcHJpdmF0ZSB0YWdzU2VydmljZTogQW5ndWxhclRhZ3NJbnB1dFNlcnZpY2VcbiAgKSB7IH1cblxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleXVwJywgWyckZXZlbnQnXSlcbiAga2V5RXZlbnQoZXZlbnQpIHtcbiAgICB0aGlzLmlucHV0S2V5UHJlc3MoZXZlbnQpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIC8vIGlmIHRoZXJlJ3Mgbm8gY2hhbmdlIGluIHRoZSB0YWdzRGF0YSwgZG8gbm90aGluZ1xuICAgIGlmICghY2hhbmdlcy50YWdzRGF0YSB8fCAhdGhpcy5pc0lucHV0Rm9jdXNlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIElmIHRoZSBwcmV2aW91cyB3YWx1ZSB3YXMgYG51bGxgIG9yIGB1bmRlZmluZWRgLCB3ZSdyZSBpbml0aWFsaXppbmcgdGhhdCBhcyBhbiBhcnJheSBoZXJlXG4gICAgLy8gc28gd2UgY2FuIGF2b2lkIGJyZWFraW5nIHRoZSBwcm9jZXNzIGZ1cnRoZXIuXG4gICAgaWYgKCFjaGFuZ2VzLnRhZ3NEYXRhLnByZXZpb3VzVmFsdWUpIHtcbiAgICAgIGNoYW5nZXMudGFnc0RhdGEucHJldmlvdXNWYWx1ZSA9IFtdO1xuICAgIH1cbiAgICAvLyBpZiB3ZSBoYXZlIHRoZSB2YWx1ZSBvZiB0aGUgdGFncyBjaGFuZ2VkLCB3ZSBuZWVkIHRvIHNob3cgdGhlIGRyb3Bkb3duIGltbWVkaWF0ZWx5XG4gICAgLy8gd2UgZG9uJ3Qgc2hvdyB0aGlzIG9uIHRoZSBmaXJzdCBjaGFuZ2UsIGJlY2F1c2UgdGhhdCdzIHdoZW4gdGhlIGZpcnN0IHZhbHVlIGlzIGFzc2lnbmVkXG4gICAgaWYgKFxuICAgICAgY2hhbmdlcy50YWdzRGF0YSAmJiBjaGFuZ2VzLnRhZ3NEYXRhLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy50YWdzRGF0YS5wcmV2aW91c1ZhbHVlXG4gICAgICAmJiAhY2hhbmdlcy50YWdzRGF0YS5maXJzdENoYW5nZVxuICAgICkge1xuICAgICAgLy8gaWYgdGhlIHZhbHVlcyBkb24ndCBtYXRjaCwgc2hvdyB0aGUgZHJvcGRvd25cbiAgICAgIGlmIChjaGFuZ2VzLnRhZ3NEYXRhLmN1cnJlbnRWYWx1ZS5sZW5ndGggIT09IGNoYW5nZXMudGFnc0RhdGEucHJldmlvdXNWYWx1ZS5sZW5ndGggJiYgISF0aGlzLmRyb3Bkb3duU2hvd25ZZXQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hvd0Ryb3Bkb3duKGNoYW5nZXMudGFnc0RhdGEuY3VycmVudFZhbHVlKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMudGFnc0RhdGEucHJldmlvdXNWYWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvKiBzaW5jZSB0aGUgdmFsdWVzIGFyZSBhcnJheSwgd2UgbmVlZCB0byBjb21wYXJlIHRoZSBlbGVtZW50cyB3aXRoaW5cbiAgICAgICAqIGF2b2lkaW5nIHRoZSB1c2FnZSBvZiBhbnkgZXh0ZXJuYWwgbGlicmFyeSwgbWF0Y2hpbmcgdGhlIGVsZW1lbnRzIHVzaW5nIGlkZW50aWZpZXJcbiAgICAgICAqIG9mIHRoZSBlbGVtZW50cyBoZXJlXG4gICAgICAgKi9cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBjaGFuZ2VzLnRhZ3NEYXRhLmN1cnJlbnRWYWx1ZS5sZW5ndGg7IGkgPCBsZW47ICsraSkge1xuICAgICAgICBpZiAoY2hhbmdlcy50YWdzRGF0YS5jdXJyZW50VmFsdWVbaV1bdGhpcy5jb25maWcuaWRlbnRpZmllcl0gIT09IGNoYW5nZXMudGFnc0RhdGEucHJldmlvdXNWYWx1ZVtpXVt0aGlzLmNvbmZpZy5pZGVudGlmaWVyXSkge1xuICAgICAgICAgIC8vIGFzIHNvb24gYXMgdGhlIGRpZmZlcmVuY2UgaW4gZWxlbWVudHMgaXMgZm91bmQsIHNob3cgdGhlIGVsZW1lbnQgYW5kIHN0b3AgZnVydGhlciBleGVjdXRpb24gb2YgZm9yIGxvb3BcbiAgICAgICAgICByZXR1cm4gdGhpcy5zaG93RHJvcGRvd24oY2hhbmdlcy50YWdzRGF0YS5jdXJyZW50VmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgb25Gb2N1c0NoYW5nZSh2YWw6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlzSW5wdXRGb2N1c2VkID0gdmFsO1xuICAgIGlmICghdmFsICYmIHRoaXMuY29uZmlnLmhpZGVERE9uQmx1cikge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaGlkZURyb3Bkb3duKCk7XG4gICAgICB9LCA0MDApO1xuICAgIH1cbiAgfVxuXG4gIG9uSW5wdXRWYWx1ZUNoYW5nZWQodmFsOiBzdHJpbmcpIHtcbiAgICB0aGlzLmlucHV0VmFsID0gdmFsO1xuICAgIHRoaXMudmFsdWVDaGFuZ2VkLmVtaXQodmFsKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuY29uZmlnID0geyAvLyBhcHBseWluZyB0aGUgY29uZmlndXJhdGlvbiBwcm92aWRlZFxuICAgICAgLi4udGhpcy5kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5jb25maWdcbiAgICB9O1xuICAgIHRoaXMuZGRTY3JvbGxTdHJhdGVneSA9IHRoaXMuc3NvLnJlcG9zaXRpb24oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAYXV0aG9yIEFoc2FuIEF5YXpcbiAgICogQGRlc2MgVHJpZ2dlcnMgd2hlbiB0aGUgdmFsdWUgb2YgdGhlIGZvcm0gY29udHJvbCAob3IgbmdNb2RlbCkgaXMgY2hhbmdlZC5cbiAgICogV2UncmUgdXNpbmcgdGhlIGhhbmRsZXIgdG8gYXNzaWduIHRoZSB2YWx1ZXMgdG8gdGhlIHRhZ3MgYXJyYXkgdGhhdCB3ZSBoYXZlLlxuICAgKi9cbiAgd3JpdGVWYWx1ZSh0YWdzOiBBcnJheTxhbnk+KTogdm9pZCB7XG4gICAgdGFncyA9IHRhZ3MgPyB0YWdzIDogW107XG4gICAgdGFncyA9IEFycmF5LmlzQXJyYXkodGFncykgPyB0YWdzIDogW3RhZ3NdO1xuICAgIHRoaXMudGFncyA9IHRhZ3MubWFwKCh0YWcpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnRhZyxcbiAgICAgICAgLi4ue1xuICAgICAgICAgIFt0aGlzLmNvbmZpZy5pZGVudGlmaWVyXTogdGFnW3RoaXMuY29uZmlnLmlkZW50aWZpZXJdLFxuICAgICAgICAgIFt0aGlzLmNvbmZpZy5kaXNwbGF5UHJvcGVydHldOiB0YWdbdGhpcy5jb25maWcuZGlzcGxheVByb3BlcnR5XSxcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5zaG93VGFnc1NlbGVjdGVkSW5ERCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMudGFncy5tYXAoKHRhZykgPT4ge1xuICAgICAgICAgIHRoaXMuc2VsZWN0UmVsYXRlZFRhZ3ModGFnKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIFJlZ2lzdGVycyB0aGUgb24gY2hhbmdlIGZ1bmN0aW9uIHRvIHRoZSB2YWx1ZSBhY2Nlc3NvclxuICAgKi9cbiAgcmVnaXN0ZXJPbkNoYW5nZSggZm46IGFueSApOiB2b2lkIHtcbiAgICB0aGlzLm9uQ2hhbmdlID0gZm47XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdG9yIGZ1bmN0aW9uIGZvciB0aGUgZm9ybSBjb250cm9sXG4gICAqIERvZXNuJ3QgZG8gYW55dGhpbmcgaWYgdGhlIGNvbnRyb2wgaXMgbm90IHJlcXVpcmVkXG4gICAqIElmIGl0IGlzIHJlcXVpcmVkLCBjaGVja3MgaWYgdGhlIGNvbnRyb2wgY29udGFpbnMgdmFsdWVcbiAgICovXG4gIHZhbGlkYXRlKGNvbnRyb2w6IEZvcm1Db250cm9sKSB7XG4gICAgaWYgKHRoaXMucmVxdWlyZWQgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuICghIWNvbnRyb2wudmFsdWUgJiYgY29udHJvbC52YWx1ZS5sZW5ndGgpID8gbnVsbCA6IHtcbiAgICAgIHJlcXVpcmVkOiB0cnVlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIFRyaWdnZXJzIHdoZW4gdGhlIHRhZyBpbnB1dCBpcyBmb2N1c2VkXG4gICAqL1xuICBvbklucHV0Rm9jdXMoKSB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmNsZWFySW5wdXRPbkZvY3VzKSB7XG4gICAgICBpZiAodGhpcy50YWdJbnB1dC5sYXN0VmFsdWVFbWl0dGVkICE9PSAnJykge1xuICAgICAgICB0aGlzLnRhZ0lucHV0LnRhZ0lucHV0Rm9ybS5nZXQoJ3RhZ0lucHV0VmFsJykuc2V0VmFsdWUoJycpO1xuICAgICAgfVxuICAgICAgdGhpcy50YWdJbnB1dC5yZXNldElucHV0KCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmNvbmZpZy5jbGVhclRhZ3NPbkZvY3VzKSB7XG4gICAgICB0aGlzLnRhZ3MubGVuZ3RoID0gMDtcbiAgICB9XG4gICAgdGhpcy5zaG93RHJvcGRvd24oKTtcbiAgICB0aGlzLm9uRm9jdXNDaGFuZ2UodHJ1ZSk7XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIFNob3dzIHRoZSBkcm9wZG93biB3aXRoIG9wdGlvbnMgbGlzdGluZ1xuICAgKi9cbiAgc2hvd0Ryb3Bkb3duKHJlY2VudFRhZ3M6IEFycmF5PGFueT4gPSBudWxsKSB7XG4gICAgY29uc3QgdW5BZGRlZFRhZ3MgPSB0aGlzLnVuQWRkZWRUYWdzUGlwZS50cmFuc2Zvcm0oXG4gICAgICAhIXJlY2VudFRhZ3MgPyByZWNlbnRUYWdzIDogdGhpcy50YWdzRGF0YSxcbiAgICAgIHtcbiAgICAgICAgdGFnc0FkZGVkOiB0aGlzLnRhZ3MsXG4gICAgICAgIGNvbmZpZzogdGhpcy5jb25maWdcbiAgICAgIH1cbiAgICApO1xuICAgIGlmICh1bkFkZGVkVGFncy5sZW5ndGgpIHsgLy8gb25seSBzaG93IGRyb3Bkb3duIHdoZW4gd2UgaGF2ZSBkYXRhIHRvIHNob3dcbiAgICAgIHRoaXMuaXNEcm9wZG93bk9wZW4gPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZHJvcGRvd25TaG93bllldCkge1xuICAgICAgdGhpcy5kcm9wZG93blNob3duWWV0ID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIEhpZGVzIHRoZSBvcHRpb25zIGxpc3RpbmcgZHJvcGRvd25cbiAgICovXG4gIGhpZGVEcm9wZG93bigpIHtcbiAgICB0aGlzLmlzRHJvcGRvd25PcGVuID0gZmFsc2U7XG4gICAgdGhpcy50YWdzRGF0YSA9IHRoaXMucmVtb3ZlS2V5Ym9hcmRTZWxlY3Rpb24odGhpcy50YWdzRGF0YSk7XG4gIH1cblxuICByZW1vdmVLZXlib2FyZFNlbGVjdGlvbihpdGVtczogQXJyYXk8QW5ndWxhclRhZ0l0ZW0+KSB7XG4gICAgcmV0dXJuIGl0ZW1zLm1hcCgodGFnOiBBbmd1bGFyVGFnSXRlbSkgPT4ge1xuICAgICAgaWYgKHRhZ1t0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQcm9wZXJ0eV0gJiYgdGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1Byb3BlcnR5XS5sZW5ndGgpIHtcbiAgICAgICAgdGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1Byb3BlcnR5XSA9IHRoaXMucmVtb3ZlS2V5Ym9hcmRTZWxlY3Rpb24odGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1Byb3BlcnR5XSk7XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi50YWcsXG4gICAgICAgIHRpS2V5Ym9hcmRBY3RpdmU6IGZhbHNlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGlmICghIXRoaXMuY29uZmlnIHx8ICF0aGlzLm9uQ2hhbmdlKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ1BsZWFzZSB1c2UgbmdNb2RlbCBvciBGb3JtQ29udHJvbE5hbWUgd2l0aCA8dGktYW5ndWxhci10YWdzLWlucHV0PicpO1xuICAgIH1cbiAgICBpZiAodGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHkpIHtcbiAgICAgIC8vIHdlIG5lZWQgdGhlIHBhcmVudCBwcm9wZXJ0eSB0byBiZSBhYmxlIHRvIHVuc2VsZWN0IHRoZSBwYXJlbnQgd2hlbiBhIGNoaWxkIHRhZyBpcyB1bnNlbGVjdGVkXG4gICAgICBpZiAoIXRoaXMuY29uZmlnLm5lc3RlZFRhZ1BhcmVudFByb3ApIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25lc3RlZFRhZ1Byb3BlcnR5IHByb3ZpZGVkIGJ1dCBuZXN0ZWRUYWdQYXJlbnRQcm9wIG5vdCBwcm92aWRlZC5cXG5UaGlzIHdpbGwgY2F1c2UgdGhlIHBhcmVudCB0YWcgdG8gbm90IHJlbW92ZSBpZiBhbnkgb2YgdGhlIGNoaWxkcmVuIGlzIHJlbW92ZWQnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIEFkZHMgdGhlIHRhZyBpbiB0aGUgdGFncyBsaXN0ICh0YWdzIGFycmF5KS5cbiAgICogQXZvaWRzIGR1cGxpY2F0ZSB0YWdzIGFkZGl0aW9uXG4gICAqIEBwYXJhbSB0YWcgLSB0YWcgdG8gYWRkXG4gICAqL1xuICBhZGRUYWcodGFnOiBBbmd1bGFyVGFnSXRlbSkge1xuICAgIGlmICh0aGlzLmNvbmZpZy5zaG93VGFnc1NlbGVjdGVkSW5ERCkge1xuICAgICAgdGFnLnRpU2VsZWN0ZWQgPSB0cnVlOyAvLyBtYXJrcyB0aGUgZWxlbWVudCBhcyBzZWxlY3RlZFxuICAgIH1cbiAgICBpZiAodGhpcy5jb25maWcubWF4SXRlbXMgPiAwICYmIHRoaXMudGFncy5sZW5ndGggPT09IHRoaXMuY29uZmlnLm1heEl0ZW1zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICghdGhpcy50YWdzLmZpbmQodGFnSXRlbSA9PiB0YWdJdGVtW3RoaXMuY29uZmlnLmlkZW50aWZpZXJdID09PSB0YWdbdGhpcy5jb25maWcuaWRlbnRpZmllcl0pKSB7XG4gICAgICB0aGlzLnRhZ3MgPSBbLi4udGhpcy50YWdzLCB0YWddO1xuICAgICAgdGhpcy5vbkNoYW5nZShcbiAgICAgICAgdGhpcy50YWdzXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAYXV0aG9yIEFoc2FuIEF5YXpcbiAgICogQGRlc2MgUmVtb3ZlcyB0aGUgdGFncyBmcm9tIHRoZSB0YWdzIGxpc3RcbiAgICogQHBhcmFtIHRhZyAtIHRhZyB0byByZW1vdmVcbiAgICovXG4gIHJlbW92ZVRhZyh0YWc6IEFuZ3VsYXJUYWdJdGVtKSB7XG4gICAgdGhpcy50YWdzID0gdGhpcy50YWdzLmZpbHRlcigodGFnSXRlbSkgPT4gdGFnSXRlbVt0aGlzLmNvbmZpZy5pZGVudGlmaWVyXSAhPT0gdGFnW3RoaXMuY29uZmlnLmlkZW50aWZpZXJdKTtcbiAgICAvLyB3aGVuIHdlJ3ZlIHJlbW92ZWQgYWxsIHRoZSB0YWdzLCB3ZSB3YW50IHRvIGdldCB0aGUgZGVmYXVsdCB0YWdzXG4gICAgaWYgKHRoaXMudGFncy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMudGFnSW5wdXQucmVzZXRJbnB1dCgpO1xuICAgICAgdGhpcy52YWx1ZUNoYW5nZWQuZW1pdCgnJyk7XG4gICAgfVxuICAgIHRoaXMub25DaGFuZ2UoXG4gICAgICB0aGlzLnRhZ3NcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBhdXRob3IgQWhzYW4gQXlhelxuICAgKiBAZGVzYyBUcmlnZ2VycyB3aGVuIHRoZSBpdGVtIGlzIGNsaWNrZWQgZnJvbSB0aGUgZHJvcGRvd25cbiAgICogQHBhcmFtIHRhZyAtIHRhZyBzZWxlY3RlZFxuICAgKi9cbiAgb25JdGVtQ2xpY2tlZCh0YWc6IEFuZ3VsYXJUYWdJdGVtKSB7XG4gICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSB0byB0b2dnbGUsIGFkZCB0aGUgaXRlbSBhcyB0YWcgcmlnaHQgYXdheVxuICAgIGlmICh0aGlzLmNvbmZpZy50b2dnbGVTZWxlY3Rpb25PbkNsaWNrKSB7XG4gICAgICAvLyB3ZSBoYXZlIHRvIHRvZ2dsZSBzZWxlY3Rpb24uIEZpcnN0LCBsZXQncyBzZWUgaWYgdGhlIHRhZyBkb2Vzbid0IGV4aXN0IGFscmVhZHkgaW4gdGhlIHNlbGVjdGVkIHRhZ3NcbiAgICAgIGlmICghdGFnLnRpU2VsZWN0ZWQgJiYgIXRoaXMudGFncy5maW5kKHRhZ0l0ZW0gPT4gdGFnSXRlbVt0aGlzLmNvbmZpZy5pZGVudGlmaWVyXSA9PT0gdGFnW3RoaXMuY29uZmlnLmlkZW50aWZpZXJdKSkge1xuICAgICAgICB0aGlzLmFkZFRhZyh0YWcpO1xuICAgICAgICB0aGlzLnNlbGVjdFJlbGF0ZWRUYWdzKHRhZyk7XG4gICAgICAgIHRoaXMudGFnQWRkZWQuZW1pdChcbiAgICAgICAgICB0aGlzLnRhZ3NTZXJ2aWNlLmdldE1haW5UYWdBZnRlckFkZGluZyhcbiAgICAgICAgICAgIHRoaXMudGFnc0RhdGEsXG4gICAgICAgICAgICB0YWcsXG4gICAgICAgICAgICB0aGlzLnRhZ3MsXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ1xuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7ICAvLyBpZiB0aGUgdGFnIGlzIGFscmVhZHkgc2VsZWN0ZWQsIHJlbW92ZVxuICAgICAgICB0aGlzLnJlbW92ZVRhZyh0YWcpO1xuICAgICAgICB0aGlzLnJlbW92ZVRhZ1NlbGVjdGlvbih0YWcpO1xuICAgICAgICB0aGlzLnRhZ1JlbW92ZWQuZW1pdCh0YWcpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFkZFRhZyh0YWcpO1xuICAgICAgdGhpcy5zZWxlY3RSZWxhdGVkVGFncyh0YWcpO1xuICAgICAgdGhpcy50YWdBZGRlZC5lbWl0KFxuICAgICAgICB0aGlzLnRhZ3NTZXJ2aWNlLmdldE1haW5UYWdBZnRlckFkZGluZyhcbiAgICAgICAgICB0aGlzLnRhZ3NEYXRhLFxuICAgICAgICAgIHRhZyxcbiAgICAgICAgICB0aGlzLnRhZ3MsXG4gICAgICAgICAgdGhpcy5jb25maWdcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gICAgdGhpcy50YWdJbnB1dC5yZXNldElucHV0KCk7XG4gICAgdGhpcy5pdGVtQ2xpY2tlZC5lbWl0KHRhZyk7XG4gICAgdGhpcy5oaWRlRHJvcGRvd24oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAYXV0aG9yIEFoc2FuIEF5YXpcbiAgICogQGRlc2MgUmVtb3ZlcyB0aGUgdGFnIHNlbGVjZWQgc3RhdGUgKGFuZCBvZiB0aGUgY2hpbGRyZW4pXG4gICAqIEBwYXJhbSB0YWcgLSB0aGUgdGFnIHRvIHVubWFyayBhcyBzZWxlY3RlZFxuICAgKi9cbiAgcmVtb3ZlVGFnU2VsZWN0aW9uKHRhZzogQW5ndWxhclRhZ0l0ZW0sIGlnbm9yZUNoaWxkcmVuID0gZmFsc2UsIGlnbm9yZVBhcmVudCA9IGZhbHNlKSB7XG4gICAgdGFnLnRpU2VsZWN0ZWQgPSBmYWxzZTtcbiAgICBpZiAoIWlnbm9yZUNoaWxkcmVuICYmIHRhZ1t0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQcm9wZXJ0eV0pIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgIHRoaXMucmVtb3ZlVGFnKHRhZ1t0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQcm9wZXJ0eV1baV0pO1xuICAgICAgICB0aGlzLnJlbW92ZVRhZ1NlbGVjdGlvbih0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldW2ldLCBpZ25vcmVDaGlsZHJlbik7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUGFyZW50UHJvcF0gJiYgIWlnbm9yZVBhcmVudCkge1xuICAgICAgY29uc3QgcGFyZW50VGFnID0gdGhpcy50YWdzU2VydmljZS5maW5kVGFnQnlJZChcbiAgICAgICAgdGhpcy50YWdzRGF0YSxcbiAgICAgICAgdGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1BhcmVudFByb3BdLFxuICAgICAgICB0aGlzLmNvbmZpZ1xuICAgICAgKTtcbiAgICAgIGlmIChwYXJlbnRUYWcgJiYgcGFyZW50VGFnLnRpU2VsZWN0ZWQpIHtcbiAgICAgICAgdGhpcy5yZW1vdmVUYWcocGFyZW50VGFnKTtcbiAgICAgICAgdGhpcy5yZW1vdmVUYWdTZWxlY3Rpb24ocGFyZW50VGFnLCB0cnVlLCBpZ25vcmVQYXJlbnQpO1xuICAgICAgICBwYXJlbnRUYWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldLm1hcCgodGFnSXRlbSkgPT4ge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0cmlwbGUtZXF1YWxzXG4gICAgICAgICAgaWYgKHRhZ0l0ZW1bdGhpcy5jb25maWcuaWRlbnRpZmllcl0gIT0gdGFnW3RoaXMuY29uZmlnLmlkZW50aWZpZXJdKSB7XG4gICAgICAgICAgICB0aGlzLmFkZFRhZyh0YWdJdGVtKTtcbiAgICAgICAgICAgIHRoaXMuc2VsZWN0UmVsYXRlZFRhZ3ModGFnSXRlbSwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMub25DaGFuZ2UoXG4gICAgICB0aGlzLnRhZ3NcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEBhdXRob3IgQWhzYW4gQXlhelxuICAgKiBAZGVzYyB0cmlnZ2VycyBvbiBjbG9zZSBidXR0b24gY2xpY2sgb2YgdGhlIHRhZ3NcbiAgICogQHBhcmFtIHRhZyAtIHRoZSB0YWcgdG8gcmVtb3ZlXG4gICAqL1xuICB0YWdDbG9zZUNsaWNrZWQodGFnKSB7XG4gICAgdGhpcy50YWdSZW1vdmVkLmVtaXQodGFnKTtcbiAgICB0aGlzLnJlbW92ZVRhZyh0YWcpO1xuICAgIHRoaXMucmVtb3ZlVGFnU2VsZWN0aW9uKHRhZyk7XG4gIH1cblxuICAvKipcbiAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAqIEBkZXNjIFNlbGVjdHMvYWRkcyB0aGUgcmV0YXRlZCB0YWdzIChwYXJlbnQgYW5kL29yIGNoaWxkcmVuKVxuICAgKiBAcGFyYW0gdGFnIC0gdGhlIHRhZyB0byBtYXJrIGFzIHNlbGVjdGVkXG4gICAqL1xuICBzZWxlY3RSZWxhdGVkVGFncyh0YWc6IEFuZ3VsYXJUYWdJdGVtLCBpZ25vcmVDaGlsZHJlbiA9IGZhbHNlLCBpZ25vcmVQYXJlbnQgPSBmYWxzZSkge1xuICAgIGlmICh0aGlzLmNvbmZpZy5zaG93VGFnc1NlbGVjdGVkSW5ERCkge1xuICAgICAgdGFnLnRpU2VsZWN0ZWQgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAodGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1Byb3BlcnR5XSAmJiAhaWdub3JlQ2hpbGRyZW4pIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSB0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5zaG93UGFyZW50VGFnc09ubHkpIHtcbiAgICAgICAgICAvLyByZW1vdmUgdGhlIGNoaWxkcmVuIGlmIHdlIG9ubHkgaGF2ZSB0byBrZWVwIHBhcmVudFxuICAgICAgICAgIHRoaXMucmVtb3ZlVGFnKHRhZ1t0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQcm9wZXJ0eV1baV0pO1xuICAgICAgICAgIC8vIG1ha2luZyBzdXJlIHdlJ3JlIHRhcmdldGluZyBvbmx5IGNoaWxkcmVuLCBpZ25vcmluZyBwYXJlbnRzXG4gICAgICAgICAgdGhpcy5zZWxlY3RSZWxhdGVkVGFncyh0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldW2ldLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5hZGRUYWcodGFnW3RoaXMuY29uZmlnLm5lc3RlZFRhZ1Byb3BlcnR5XVtpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRhZ1t0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQYXJlbnRQcm9wXSAmJiAhaWdub3JlUGFyZW50KSB7XG4gICAgICBjb25zdCBwYXJlbnRUYWcgPSB0aGlzLnRhZ3NTZXJ2aWNlLmZpbmRUYWdCeUlkKFxuICAgICAgICB0aGlzLnRhZ3NEYXRhLFxuICAgICAgICB0YWdbdGhpcy5jb25maWcubmVzdGVkVGFnUGFyZW50UHJvcF0sXG4gICAgICAgIHRoaXMuY29uZmlnXG4gICAgICApO1xuICAgICAgaWYgKCFwYXJlbnRUYWcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgcGFyZW50VGFnQ2hpbGRyZW4gPSBwYXJlbnRUYWdbdGhpcy5jb25maWcubmVzdGVkVGFnUHJvcGVydHldLmxlbmd0aDtcbiAgICAgIGNvbnN0IGNoaWxkcmVuc1NlbGVjdGVkID0gdGhpcy50YWdzLmZpbHRlcigodGFnSXRlbSkgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dHJpcGxlLWVxdWFsc1xuICAgICAgICByZXR1cm4gdGFnSXRlbVt0aGlzLmNvbmZpZy5uZXN0ZWRUYWdQYXJlbnRQcm9wXSA9PSBwYXJlbnRUYWdbdGhpcy5jb25maWcuaWRlbnRpZmllcl07XG4gICAgICB9KS5sZW5ndGg7XG4gICAgICBpZiAoXG4gICAgICAgICggcGFyZW50VGFnQ2hpbGRyZW4gPiAwICYmIGNoaWxkcmVuc1NlbGVjdGVkID4gMCApICYmXG4gICAgICAgICh0aGlzLmNvbmZpZy5jaGlsZHJlbkNvdW50UHJvcGVydHkgP1xuICAgICAgICAgIGNoaWxkcmVuc1NlbGVjdGVkID09PSBwYXJlbnRUYWdbdGhpcy5jb25maWcuY2hpbGRyZW5Db3VudFByb3BlcnR5XSA6XG4gICAgICAgICAgY2hpbGRyZW5zU2VsZWN0ZWQgPT09IHBhcmVudFRhZ0NoaWxkcmVuXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICB0aGlzLmFkZFRhZyhwYXJlbnRUYWcpO1xuICAgICAgICB0aGlzLnNlbGVjdFJlbGF0ZWRUYWdzKHBhcmVudFRhZywgZmFsc2UsIGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5vbkNoYW5nZShcbiAgICAgIHRoaXMudGFnc1xuICAgICk7XG4gIH1cblxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KTogdm9pZCB7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cblxuICBpbnB1dEtleVByZXNzKCRldmVudCkge1xuICAgICRldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICBpZiAoXG4gICAgICAhdGhpcy5pc0Ryb3Bkb3duT3BlbiAmJlxuICAgICAgKFxuICAgICAgICAkZXZlbnQua2V5ID09PSBLRVlfQ09ERVMuQVJST1dfVVAgfHxcbiAgICAgICAgJGV2ZW50LmtleSA9PT0gS0VZX0NPREVTLkFSUk9XX0RPV05cbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRoaXMuaXNEcm9wZG93bk9wZW4gPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICB0aGlzLmlzRHJvcGRvd25PcGVuICYmXG4gICAgICAkZXZlbnQua2V5ID09PSBLRVlfQ09ERVMuRVNDQVBFXG4gICAgKSB7XG4gICAgICByZXR1cm4gdGhpcy5oaWRlRHJvcGRvd24oKTtcbiAgICB9XG4gICAgLy8gc28gd2UgaGF2ZSB0aGUgZHJvcGRvd24gc2hvd25cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlmICh0aGlzLmRyb3Bkb3duKSB7XG4gICAgICAgIHRoaXMuZHJvcGRvd24uaGFuZGxlS2V5VXAoJGV2ZW50KTtcbiAgICAgIH1cbiAgICB9LCAxMCk7XG4gIH1cblxufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBbmd1bGFyVGFnc0lucHV0VmFsdWVBY2Nlc3NvcigpIHtcbiAgcmV0dXJuIHtcbiAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBBbmd1bGFyVGFnc0lucHV0Q29tcG9uZW50KSxcbiAgICBtdWx0aTogdHJ1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFuZ3VsYXJUYWdzSW5wdXRWYWxpZGF0b3JzUHJvdmlkZXIoKSB7XG4gIHJldHVybiB7XG4gICAgcHJvdmlkZTogTkdfVkFMSURBVE9SUyxcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBBbmd1bGFyVGFnc0lucHV0Q29tcG9uZW50KSxcbiAgICBtdWx0aTogdHJ1ZSxcbiAgfTtcbn1cbiJdfQ==